# 实时"低"延迟学习

![精华原文](https://mp.weixin.qq.com/s/yOs1VD8MVLqKKMClxOXz6g)  




## 常见实时场景 

* “吃鸡”游戏语言
* 语音聊天室
* 直播连麦
* 儿童手表
* 远程教育
* 远程医疗等


## 实时延时分三类

*  T1：设备端上的延时
*  		主要与硬件性能、采用的编解码算法、音视频数据量相关，设备端上的延时可达到 30~200ms，甚至更高。

	**音频在设备端上的延时：**

		（1）音频采集延时 
		
		采集后的音频首先会经过声卡进行信号转换，声卡本身会产生延时，比如 M-Audio 声卡设备延迟 1ms，艾肯声卡设备延迟约为 37ms；
		
		（2）编解码延时
		
		随后音频进入前处理、编码的阶段，如果采用 OPUS 标准编码，最低算法延时大约需要 2.5~60ms；
		
		（3）音频播放延时 
		
		这部分延时与播放端硬件性能相关。
		
		（4）音频处理延时
		
		前后处理，包括 AEC，ANS，AGC 等前后处理算法都会带来算法延时，通常这里的延时就是滤波器阶数。在 10ms 以内。
		
		（5）端网络延时：这部分延时主要出现在解码之前的 jitter buffer 内，如果在抗丢包处理中，增加了重传算法和前向纠错算法，这里的延时一般在 20ms 到 200ms 左右。但是受到 jitter buffer 影响，可能会更高。
		
	**视频在设备端上的延时：**
		
		（1）采集延时
		采集时会遇到成像延迟，主要由 CCD 相关硬件产生，市面上较好的 CCD 一秒可达 50 帧，成像延时约为 20ms，如果是一秒 20~25 帧的 CCD，会产生 40~50ms 的延时；
		
		（2）编解码延时
		以 H.264 为例，它包含 I、P、B 三种帧（下文会详细分析），如果是每秒 30 帧相连帧，且不包括 B 帧（由于 B 帧的解码依赖前后视频帧会增加延迟），采集的一帧数据可能直接进入编码器，没有 B 帧时，编码的帧延时可以忽略不计，但如果有 B 帧，会带来算法延时。
		
		（3）视频渲染延时
		一般情况下渲染延时非常小，但是它也会受到系统性能、音画同步的影响而增大。
		
		（4）端网络延时
		与音频一样，视频也会遇到端网络延时。

*  T2：端与服务器间的延时
	
	主要几个因素
	*  	客户端同服务间的物理距离
	*  	客户端和服务器的网络运营商
	*  	终端网络的网速
	*  	负载和网络类型等
		
*  T3：服务器间的延时

		端都连接着同一个边缘节点
		采集端与播放端数据会经由“靠近”的边缘节点传输至主干网络

		
 ## 延时低≠通话质量可靠
	实时音频通讯质量的因素：
	* 	频采样率 : 连续信号中提取并组成离散信号的采样个数 
	
	* 	码率 : 单位时间长度的媒体内容需要空间
	
	* 	延时 : 采样率越高、码率越高，音质就越好，但是相应单个采样信息量就越大，那么传输时间可能会相对更长

	实时视频质量的因素:
		
	* 码率 : 分辨率一定的情况下码率与清晰度成正比关系
	
	* 帧率 : 每秒钟刷新的图像帧数，流畅度
	
	* 分辨率 : 单位英寸中包的像素点数,影响图像的，清晰度
	
	* 延时 ：只是实时视频通话中多种质量问题的一个问题。
	
	网络传输稳定的情况下，想获得越低的延时，就需要在流畅度、视频清晰度、音频质量等方面进行权衡
			
## 不同场景下的实时音视频

### 游戏场景

场景|  枪战|电竞|卡牌|桌游|IO游戏|休闲游戏 |
---- | -----  | -----  | -----  | -----  | -----  | -----  | 
延迟要求| 低延迟| 低延迟 |低延迟 |较低延迟|一般|一般| 

* 性能类：包括 SDK 包大小、流量使用情况、CPU 与内存占用率、功耗

* 体验类：包括网络延迟、回音消除、抗杂音能力等			

### 社交直播

场景|  枪战 |
---- | -----  |
音/画质| 颜控、音控的社交体验| 
开放性|易于实现功能创新 | 
流畅度| 视频质量| 
低延迟| 画质与延迟中取平衡| 

### K歌
场景|  枪战 |
---- | -----  |
低延迟| 必须| 
音质|保留用户原声 | 
歌声跟歌曲| 同步| 


### 在线教育

场景|  枪战 |
---- | -----  |
低延迟|画质与延迟中取平衡| 
质量|不卡、不断，不糊| 
教学功能| 白板等| 

* 音视频播放流畅：直播音视频画面不会出现卡顿、画面模糊等情况
* 回放功能：一些有价值的演讲，或技术门槛较高的内容都需要有回放功能

## 瓶颈与权衡

延时是因多个阶段的数据处理、传输而产生的，肯定有它触及天花板的时候。

实际环境中，要考虑边缘节点的部署、主干网络拥塞、弱网环境、设备性能、系统性能等问题，实际延时会更大。

在一定的网络条件限制下，针对不同场景选择低延时方案或技术选型时，就需要围绕延时、卡顿、音频质量、视频清晰度等指标进行权衡与判断。

